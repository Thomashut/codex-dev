<dom-module id="codex-view">
  <template>
  <firebase-auth
    user="{{user}}">
  </firebase-auth>

  <firebase-query
    id="posts"
    path="/posts"
    data="{{posts}}">
  </firebase-query>

  <firebase-query
    id="commentQuery"
    path="/posts/[[post.$key]]/comments"
    data="{{comments}}">
  </firebase-query>

  <h1> View Post </h1>

  <template is="dom-if" if="[[!post]]">
      <p> No Post Found <paper-button on-tap="home"> Return to Home </paper-button> </p>
  </template>

  <template id="postView" is="dom-if" if="[[post]]">
    <template id="returnView" is="dom-if" if="[[post.parentTag]]">
      <paper-button raised on-tap="previous" post="[[post]]"> Return to the Previous Post </paper-button>
    </template>

    <ul>
      <li> [[post.title]] </li>
      <li> [[post.language]] </li>
      <li> [[post.author]] </li>
      <li> [[post.content]] </li>

      <br/>

      <li> [[post.conRank]] </li>
      <li> [[post.explainRank]] </li>
      <li> [[post.linkRank]] </li>
      <li> [[post.rank]] </li>
      <li> <paper-button id="saveButton" raised on-tap="savePost" post="[[post]]"
              alreadySaved="false"> Save Post </paper-button>
          </li>
    </ul>
  </template>

  <h4> Tagged Posts </h4>
  <paper-button raised on-tap="refreshTags"> Load Tagged Posts </paper-button>
  <ul>
    <template id="tagRepeat" is="dom-repeat" items="{{posts}}" as="tag" filter="_filter" observe="post">
        <li> [[tag.title]] </li>
        <li> [[tag.language]] </li>
        <li> [[tag.author]] </li>
        <paper-button raised on-tap="viewTag" tag="[[tag]]"> View Tag </paper-button>
    </template>
  </ul>

  <h4> Discussion Section </h4>
  <div id="postComment">
    <paper-input id="commentBody" label="Post Comment"></paper-input>
    <paper-button raised on-tap="saveComment"> Save Button </paper-button>
  </div>


  <paper-button raised on-tap="refreshComments"> Load Comments </paper-button>
  <ul>
    <template id="commentRepeat" is="dom-repeat" items="{{comments}}" as="comment">
      <li> <img src="[[comment.authorURL]]" alt="User Image"/>
      <li> [[comment.author]] </li>
      <li> [[comment.body]] </li>
    </template>
  </ul>

  </template>
  <script>
    class codex_view extends Polymer.Element {

      static get is() {return "codex-view";}

      static get properties() {
        return {
          user: {
            type: Object
          },
          post: {
            type: Object
          },
          posts: {
            type: Object,
            notify: true
          },
          page: {
            type: Object,
            notify: true
          },
          comments: {
            type: Object,
            notify: true
          }
        }
      }

      ready() {
        super.ready();
        this.$.postView.render(); // Refresh the post template
        if(this.$.tagRepeat) {
          this.$.tagRepeat.render();
        }
        if(this.$.returnView) {
          this.$.returnView.render();
        }
        if(this.$.commentRepeat && this.post) {
          this.$.commentQuery.path = "/posts/" + this.post.$key + "/comments";
          this.$.commentRepeat.render();
        }
      }

      home() {
        this.$.page = "home";
      }

      savePost(e) {
        var postToSave = e.currentTarget.post;

        if(!postToSave) {
          console.log("Create Propper Error Messages - No Post to Save");
          return -1;
        }

        // Intilizse the saved List
        if(!localStorage.getItem("savedPosts")) {
          var savedPosts = new Array();
          savedPosts.push(postToSave);
          localStorage.setItem("savedPosts",JSON.stringify(savedPosts));
        } else {
          var savedPosts = JSON.parse(localStorage.getItem("savedPosts"))
          localStorage.removeItem("savedPosts"); // Clear local Storage
          savedPosts.push(postToSave);
          localStorage.setItem("savedPosts",JSON.stringify(savedPosts));
        }
      }

      _filter(result) {
        if(!this.post) {return false;}
        if(!result) {return false;}
        var queryKey = result.$key;
        var postTags = JSON.parse(this.post.taggedPosts);
        console.log("QK: " + queryKey + " PT " + postTags);

        if(postTags.length <= 0) {return false;} // No tags
        else {
          for(var i = 0; i < postTags.length; i++) {
            if(postTags[i] == queryKey) return true;
          }
        }
      }

      viewTag(e) {
          var currentTag = e.currentTarget.tag;
          if(!currentTag) {
            console.log("ERROR - MISSING TAG");
            return -1;
          }

          currentTag.parentTag = this.post; // Used so the user can go back up the trail
          this.post = null;
          this.page = "home";
          this.post = currentTag;
          this.ready(); // Refresh the page
          this.$.tagRepeat.render();
          this.page = "view";
      }

      saveComment(e) {
        if(!this.$.commentBody || !this.post) {
          console.log("Need Proper Errors - No Comment to post or post to comment on");
          return -1;
        }

        var commentBobdy = this.$.commentBody.value;
        var key = this.post.$key;

        this.$.commentQuery.path = "/posts/" + this.post.$key + "/comments";

        var photoURL = null;
        if(this.user.photoURL) {
          photoURL = this.user.photoURL
        }

        this.$.commentQuery.ref.push({
          authorURL: photoURL,
          body: this.$.commentBody.value,
          author: this.user.displayName
        }); // Push the comment to the database

        this.$.commentBody.value = "";

      }

      previous(e) {
        var post = this.post;
        this.post = null;
        this.post = post.parentTag; // Current post become equal to the parent post
        this.page = "home";
        this.page = "view";
        this.ready(); // Refresh the page
        this.$.tagRepeat.render();
      }

      refreshTags() {
        this.page = "home";
        this.ready();
        this.page = "view";
      }

      refreshComments() {
        this.ready();
      }
    }

    customElements.define(codex_view.is,codex_view);
  </script>
</dom-module>
